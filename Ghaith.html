<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© ØºÙŠØ« Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙƒØ¨ÙŠØ± | Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØ¶Ø±Ø±ÙŠÙ†</title>
    
    <!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Leaflet (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù…ÙØªØ§Ø­ API Ù…Ø¹Ù‚Ø¯) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Ø®Ø· ØªØ¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00897b; /* Ù„ÙˆÙ† Ø§Ù„ØºÙŠØ« Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ù…Ø±ÙŠØ­ */
            --primary-dark: #005b4f;
            --accent: #ff6f00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #333333;
            --gray: #777777;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding-bottom: 60px;
        }

        /* Header */
        header {
            background: var(--white);
            padding: 1rem 5%;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn {
            background: none;
            border: none;
            font-family: inherit;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--gray);
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }

        .nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 700;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Sections */
        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        h2 { color: var(--primary-dark); margin-bottom: 1.5rem; border-right: 4px solid var(--accent); padding-right: 1rem; }

        /* Form Styling */
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem; }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            transition: 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,137,123,0.1);
        }

        .btn-gps {
            background: #e0f2f1;
            color: var(--primary-dark);
            border: 1px solid var(--primary);
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 5px;
        }

        .btn-gps:hover { background: #b2dfdb; }

        .btn-submit {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            width: 100%;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            transition: 0.3s;
        }

        .btn-submit:hover { background: var(--primary-dark); }

        /* Map */
        #map { height: 500px; width: 100%; border-radius: var(--radius); z-index: 1; }

        /* Admin Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 1rem; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--primary-dark); }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-export {
            background: var(--text);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
            z-index: 2000;
        }
        #toast.show { opacity: 1; visibility: visible; bottom: 50px; }

        /* Popup Customization */
        .leaflet-popup-content-wrapper { border-radius: 8px; font-family: 'Tajawal', sans-serif; }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.9rem; }
        .popup-label { font-weight: bold; color: var(--gray); }

        /* Responsive */
        @media (max-width: 600px) {
            header { flex-direction: column; gap: 1rem; }
            .nav-btn { font-size: 0.9rem; padding: 0.5rem; }
            #map { height: 350px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            ğŸŒ§ï¸ ØºÙŠØ« Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙƒØ¨ÙŠØ±
        </div>
        <nav>
            <button class="nav-btn active" onclick="switchTab('form')">ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ¶Ø±Ø±</button>
            <button class="nav-btn" onclick="switchTab('map')">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØªØ¶Ø±Ø±ÙŠÙ†</button>
            <button class="nav-btn" onclick="switchTab('admin')">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </nav>
    </header>

    <div class="container">
        
        <!-- 1. Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <section id="form-section" class="section active">
            <div class="card">
                <h2>ğŸ“ Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ø¬Ù„</h2>
                <form id="aidForm">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠ ÙˆØ§Ù„Ø¹Ø§Ø¦Ù„ÙŠ</label>
                        <input type="text" id="fullName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ" required>
                    </div>

                    <div class="form-group">
                        <label>Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ / Ø§Ù„Ø­ÙŠ</label>
                        <input type="text" id="location" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¨Ø§Ø±Ø²" required>
                    </div>

                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                        <select id="aidType" required>
                            <option value="Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                            <option value="Ù…Ø£ÙˆÙ‰">Ù…Ø£ÙˆÙ‰ / Ø¥ÙŠÙˆØ§Ø¡</option>
                            <option value="Ø£Ø¯ÙˆÙŠØ©">Ø£Ø¯ÙˆÙŠØ© Ø£Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø·Ø¨ÙŠØ©</option>
                            <option value="Ù…Ù„Ø§Ø¨Ø³ ÙˆØ£ØºØ·ÙŠØ©">Ù…Ù„Ø§Ø¨Ø³ ÙˆØ£ØºØ·ÙŠØ©</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>

                    <div class="form-group" id="otherAidGroup" style="display:none;">
                        <label>ØªÙˆØ¶ÙŠØ­ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</label>
                        <input type="text" id="otherAidText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§...">
                    </div>

                    <div class="form-group">
                        <label>ÙˆØµÙ Ø§Ù„Ø¶Ø±Ø±</label>
                        <textarea id="damageDesc" rows="3" placeholder="ØµÙ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„Ø°ÙŠ Ù„Ø­Ù‚ Ø¨Ùƒ (Ù…Ø«Ø§Ù„: ØºØ±Ù‚ Ø§Ù„Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø±Ø¶ÙŠØŒ ØªØ¶Ø±Ø± Ø§Ù„Ø£Ø«Ø§Ø«...)" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (GPS)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="gpsCoords" placeholder="Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ( latitude, longitude )" readonly required>
                            <button type="button" class="btn-gps" style="width: auto;" onclick="getGPS()">
                                ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ
                            </button>
                        </div>
                        <small style="color: var(--gray);">ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù„Ø¸Ù‡Ø±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØªØ³Ù‡ÙŠÙ„ ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©.</small>
                    </div>

                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù„Ù„ØªÙˆØ§ØµÙ„)</label>
                        <input type="tel" id="phone" placeholder="06XXXXXXXX">
                    </div>

                    <div class="form-group">
                        <label>Ø±ÙØ¹ ØµÙˆØ± ØªÙˆØ«ÙŠÙ‚ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="file" id="imageUpload" accept="image/*">
                        <small style="color: var(--gray);">Ø³ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±.</small>
                    </div>

                    <button type="submit" class="btn-submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                </form>
            </div>
        </section>

        <!-- 2. Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
        <section id="map-section" class="section">
            <div class="card">
                <h2>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ØªØ¶Ø±Ø±ÙŠÙ†</h2>
                <p style="margin-bottom: 1rem; color: var(--gray);">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©ØŒ ÙˆØ§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©.</p>
                <div id="map"></div>
            </div>
        </section>

        <!-- 3. Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
        <section id="admin-section" class="section">
            <div class="card">
                <h2>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h2>
                
                <div class="toolbar">
                    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…ÙƒØ§Ù†..." onkeyup="renderTable()" style="max-width: 300px;">
                    <select id="filterAid" onchange="renderTable()" style="max-width: 200px;">
                        <option value="all">ÙƒÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</option>
                        <option value="Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©">Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©</option>
                        <option value="Ù…Ø£ÙˆÙ‰">Ù…Ø£ÙˆÙ‰</option>
                        <option value="Ø£Ø¯ÙˆÙŠØ©">Ø£Ø¯ÙˆÙŠØ©</option>
                    </select>
                    <button class="btn-export" onclick="exportToCSV()">â¬‡ ØªØµØ¯ÙŠØ± CSV</button>
                </div>

                <div class="table-responsive">
                    <table id="adminTable">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                                <th>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</th>
                                <th>Ø§Ù„Ø¶Ø±Ø±</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

    <div id="toast">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ==========================================
        
        // âš ï¸ Ù‡Ø§Ù…: Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø¥Ù„Ù‰ true Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹ Ù…ÙØ§ØªÙŠØ­ Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        const useRealDatabase = false; 

        // Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù‡Ù†Ø§ (Ø§Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† Console -> Project Settings)
        const firebaseConfig = {
            apiKey: "AIzaSyD-XXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        let db;
        if (useRealDatabase) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        }

        // ==========================================
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© (State Management)
        // ==========================================
        let map;
        let markers = [];
        let allData = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¨Ø­Ø«

        // Ø¹Ù†Ø¯ ÙØªØ­ "Ø£Ø®Ø±Ù‰" ÙÙŠ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
        document.getElementById('aidType').addEventListener('change', function() {
            const otherGroup = document.getElementById('otherAidGroup');
            otherGroup.style.display = this.value === 'Ø£Ø®Ø±Ù‰' ? 'block' : 'none';
        });

        // ==========================================
        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // ==========================================

        function switchTab(tabId) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            document.getElementById(tabId + '-section').classList.add('active');
            document.querySelector(`.nav-btn[onclick="switchTab('${tabId}')"]`).classList.add('active');

            // Ø¥Ø°Ø§ ÙØªØ­Ù†Ø§ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (tabId === 'map') {
                setTimeout(initMap, 100); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ù†ØµØ±
            } else if (tabId === 'admin') {
                renderTable();
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (GPS)
        function getGPS() {
            const input = document.getElementById('gpsCoords');
            if (navigator.geolocation) {
                input.value = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(5);
                        const lng = position.coords.longitude.toFixed(5);
                        input.value = `${lat}, ${lng}`;
                    },
                    (error) => {
                        input.value = "";
                        alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ ÙƒØªØ§Ø¨ØªÙ‡ ÙŠØ¯ÙˆÙŠØ§Ù‹.");
                    }
                );
            } else {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
            }
        }

        // ==========================================
        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // ==========================================

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('aidForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const aidType = document.getElementById('aidType').value;
            const finalAidType = aidType === 'Ø£Ø®Ø±Ù‰' ? document.getElementById('otherAidText').value : aidType;
            const gpsText = document.getElementById('gpsCoords').value;
            
            // ØªØ­ÙˆÙŠÙ„ GPS Ø¥Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù…
            let lat = null, lng = null;
            if (gpsText.includes(',')) {
                const parts = gpsText.split(',');
                lat = parseFloat(parts[0].trim());
                lng = parseFloat(parts[1].trim());
            }

            const newRequest = {
                name: document.getElementById('fullName').value,
                location: document.getElementById('location').value,
                aidType: finalAidType,
                damage: document.getElementById('damageDesc').value,
                phone: document.getElementById('phone').value,
                gps: { lat, lng },
                timestamp: new Date().toISOString()
            };

            if (useRealDatabase) {
                // Ø­ÙØ¸ ÙÙŠ Firebase
                try {
                    await db.collection('requests').add(newRequest);
                    showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
                    e.target.reset();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
                }
            } else {
                // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)
                const localData = JSON.parse(localStorage.getItem('ghaith_data') || '[]');
                newRequest.id = Date.now(); // Ù…Ø¹Ø±Ù ÙˆÙ‡Ù…ÙŠ
                localData.push(newRequest);
                localStorage.setItem('ghaith_data', JSON.stringify(localData));
                showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©)!");
                e.target.reset();
            }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function fetchData() {
            if (useRealDatabase) {
                try {
                    const snapshot = await db.collection('requests').get();
                    allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (e) {
                    console.error(e);
                }
            } else {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
                let data = JSON.parse(localStorage.getItem('ghaith_data') || '[]');
                if(data.length === 0) {
                    // Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                    data = [
                        {name: "Ø£Ø­Ù…Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙ†ÙŠ", location: "Ø­ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…", aidType: "Ù…Ø£ÙˆÙ‰", damage: "ØºØ±Ù‚ ÙƒØ§Ù…Ù„", phone: "0611111111", gps: {lat: 35.05, lng: -5.90}},
                        {name: "ÙØ§Ø·Ù…Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡", location: "Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", aidType: "Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©", damage: "ØªØ¶Ø±Ø± Ø¬Ø²Ø¦ÙŠ", phone: "0622222222", gps: {lat: 35.06, lng: -5.91}}
                    ];
                }
                allData = data;
            }
        }

        // ==========================================
        // Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Leaflet.js)
        // ==========================================
        async function initMap() {
            await fetchData();

            if (!map) {
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (ØªØªÙ…Ø­ÙˆØ± Ø­ÙˆÙ„ Ø§Ù„Ù‚ØµØ± Ø§Ù„ÙƒØ¨ÙŠØ± ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹)
                map = L.map('map').setView([35.062, -5.905], 13);
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenStreetMap (Ù…Ø¬Ø§Ù†ÙŠ)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            }

            // Ù…Ø³Ø­ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            allData.forEach(item => {
                if (item.gps && item.gps.lat && item.gps.lng) {
                    const markerColor = item.damage.includes('ÙƒÙ„ÙŠ') || item.aidType === 'Ù…Ø£ÙˆÙ‰' ? 'red' : 'blue';
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø³ÙŠØ·Ø©
                    const marker = L.marker([item.gps.lat, item.gps.lng])
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-content">
                                <h3 style="margin:0 0 8px 0; color:var(--primary)">${item.name}</h3>
                                <div class="popup-row"><span class="popup-label">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©:</span> <span>${item.aidType}</span></div>
                                <div class="popup-row"><span class="popup-label">Ø§Ù„Ù…ÙƒØ§Ù†:</span> <span>${item.location}</span></div>
                                <div class="popup-row"><span class="popup-label">Ø§Ù„Ø¶Ø±Ø±:</span> <span>${item.damage}</span></div>
                                ${item.phone ? `<div class="popup-row"><span class="popup-label">Ø§Ù„Ù‡Ø§ØªÙ:</span> <a href="tel:${item.phone}">${item.phone}</a></div>` : ''}
                            </div>
                        );
                    markers.push(marker);
                }
            });
        }

        // ==========================================
        // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        // ==========================================
        async function renderTable() {
            await fetchData();

            const tbody = document.querySelector('#adminTable tbody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterAid').value;

            tbody.innerHTML = '';

            const filteredData = allData.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(search) || item.location.toLowerCase().includes(search);
                const matchesFilter = filter === 'all' || item.aidType === filter;
                return matchesSearch && matchesFilter;
            });

            filteredData.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.location}</td>
                    <td><span style="background:#e0f2f1; padding:2px 8px; border-radius:4px; font-size:0.85rem; color:var(--primary-dark)">${item.aidType}</span></td>
                    <td>${item.damage}</td>
                    <td>${item.phone || '-'}</td>
                    <td>${item.gps && item.gps.lat ? `${item.gps.lat}, ${item.gps.lng}` : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportToCSV() {
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØµÙŠØºØ© CSV
            const headers = ['Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù…ÙƒØ§Ù†', 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©', 'Ø§Ù„Ø¶Ø±Ø±', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª'];
            const rows = allData.map(item => [
                `"${item.name}"`,
                `"${item.location}"`,
                `"${item.aidType}"`,
                `"${item.damage}"`,
                `"${item.phone}"`,
                `"${item.gps ? item.gps.lat + ',' + item.gps.lng : ''}"`
            ]);

            const csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Ghaith_Victims_Data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>